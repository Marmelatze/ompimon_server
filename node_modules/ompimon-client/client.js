var crypto = require("crypto");


exports.start = function() {
    var WebSocketServer = require('ws').Server
        , wss = new WebSocketServer({port: 8080});

    var protocol = new (require("./protocol/").protocol);

    wss.on('connection', function (socket) {


        if (!socket.id) {
            socket.id = crypto.createHash('md5').update(crypto.randomBytes(512)).digest('hex');
        }
        console.log("client "+socket.id+" connected");

        socket.on('message', function (data) {
            console.log("client " + socket.id);
            data = JSON.parse(data);
            protocol.handle(socket, data);

            console.log(JSON.stringify(data, null, 2));
        });
        socket.on('disconnect', function() {
            console.log("disconnected");
        });
    });

    protocol.on('send', function(socket, data) {
        console.log("send to "+socket.id);
        console.log(data.getData());
        socket.send(JSON.stringify(data.getData()));
    });
};

exports.test = require("./test");