var
    crypto = require("crypto"),
    Protocol = require("ompimon-protocol"),
    Client = require("./client")
    ;


exports.start = function() {

    var protocol = new Protocol();

    var WebSocketServer = require('ws').Server
        , wss = new WebSocketServer({port: 8080});

    wss.on('connection', function (socket) {
        var id = crypto.createHash('md5').update(crypto.randomBytes(512)).digest('hex');
        var client = new Client(id, socket);

        console.log("client "+client.id+" connected");

        socket.on('message', function (data) {
            console.log(data);
            protocol.parseClient(client, data);

            console.log(data);
        });
        socket.on('disconnect', function() {
            console.log("disconnected");
        });
    });

    protocol.on('send', function(client, data) {
        console.log("send to "+client.id);
        console.log(data);
        client.socket.send(data, {binary: true});
    });
};
