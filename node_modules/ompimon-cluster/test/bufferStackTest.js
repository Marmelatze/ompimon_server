var
    BufferStack = require("../BufferStack"),
    BufferBuilder = require("buffer-builder"),
    Parser = require("ompimon-protocol/parser")
    ;

module.exports = {
    testPush: function(test) {
        var buffer1 = new BufferBuilder();
        buffer1.appendUInt32BE(0x02);
        buffer1.appendUInt8(0x01);
        buffer1.appendUInt8(0x02);

        var bufferStack = new BufferStack();
        bufferStack.on('pushed', function() {
            var buf = bufferStack.pop();
            var parser = new Parser(buf);
            test.equal(parser.readUInt8(), 0x01);
            test.equal(parser.readUInt8(), 0x02);
            test.done();
        });
        bufferStack.push(buffer1.get());
    },

    testPushPartial: function(test) {
        var buffer1 = new BufferBuilder();
        buffer1.appendUInt32BE(0x02);
        buffer1.appendUInt8(0x01);

        var buffer2 = new BufferBuilder();
        buffer2.appendUInt8(0x02);

        var bufferStack = new BufferStack();
        bufferStack.on('pushed', function() {
            var buf = bufferStack.pop();
            var parser = new Parser(buf);
            test.equal(parser.readUInt8(), 0x01);
            test.equal(parser.readUInt8(), 0x02);
            test.done();
        });
        bufferStack.push(buffer1.get());
        bufferStack.push(buffer2.get());
    },

    testPushPartial3: function(test) {
        var buffer1 = new BufferBuilder();
        buffer1.appendUInt32BE(0x03);
        buffer1.appendUInt8(0x01);

        var buffer2 = new BufferBuilder();
        buffer2.appendUInt8(0x02);

        var buffer3 = new BufferBuilder();
        buffer3.appendUInt8(0x03);

        var bufferStack = new BufferStack();
        bufferStack.on('pushed', function() {
            var buf = bufferStack.pop();
            var parser = new Parser(buf);
            test.equal(parser.readUInt8(), 0x01);
            test.equal(parser.readUInt8(), 0x02);
            test.equal(parser.readUInt8(), 0x03);
            test.done();
        });
        bufferStack.push(buffer1.get());
        bufferStack.push(buffer2.get());
        bufferStack.push(buffer3.get());
    },

    testPushPartial4: function(test) {
        var buffer1 = new BufferBuilder();
        buffer1.appendUInt32BE(0x02);
        buffer1.appendUInt8(0x01);

        var buffer2 = new BufferBuilder();
        buffer2.appendUInt8(0x02); // belongs to message 1
        buffer2.appendUInt32BE(0x02); // new message
        buffer2.appendUInt8(0x02);
        buffer2.appendUInt8(0x03);


        var bufferStack = new BufferStack();
        var count = 0;
        bufferStack.on('pushed', function() {
            var buf = bufferStack.pop();
            var parser = new Parser(buf);
            if (count == 0) {
                test.equal(parser.readUInt8(), 0x01);
                test.equal(parser.readUInt8(), 0x02);
            } else if (count == 1) {
                test.equal(parser.readUInt8(), 0x02);
                test.equal(parser.readUInt8(), 0x03);
                test.done();
            }
            count++;
        });
        bufferStack.push(buffer1.get());
        bufferStack.push(buffer2.get());

    }
}