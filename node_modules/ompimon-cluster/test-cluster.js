var net = require('net'),
    BufferBuilder = require('buffer-builder'),
    procotolStub = require("ompimon-protocol/test-stub")

;




var client = net.connect({port: 8214},function() {
    this.token = '';
    console.log('client connected');

    var data = procotolStub.buildInit(procotolStub.initData).get();
    var buffer = new BufferBuilder();
    buffer.appendUInt8(0x01);
    buffer.appendBuffer(data);
    buffer = buffer.get();

    client.write(buffer);

});


client.on('data', function(data) {
    console.log("received:", data);

    if (data.readUInt8(0) == 0x01) {
        console.log("send");
        send();
    }
});


client.on('end', function() {
    console.log('client disconnected');
});

function send() {
    var data = procotolStub.buildSend(procotolStub.sendData).get();
    var buffer = new BufferBuilder();
    buffer.appendUInt8(0x02);
    buffer.appendBuffer(data);
    buffer = buffer.get();

    console.log("size: " + buffer.length + "byte");


    for (var i = 0; i < 100000; i++) {
        //setTimeout(function() {
            client.write(buffer);

        //}, i * 1);
    }
}