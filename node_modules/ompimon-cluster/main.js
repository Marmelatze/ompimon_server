var cluster = require("cluster");
var numCPUs = require('os').cpus().length;
//numCPUs = 1;
//numCPUs = 2;
var Worker = require("./worker"),
    Storage = require("ompimon-storage");


exports.start = function() {
    if (numCPUs <= 1) {
        new Worker(8214);

        return;
    }

    if (cluster.isMaster) {
        // Finalize all not finalized apps
        Storage.getApplications(function(err, apps) {
            apps.forEach(function(app) {
                Storage.finalize(app.id, function() {
                    console.log("Finalized app "+ app.id);
                })
            });
        });

        // Fork workers.
        for (var i = 0; i < numCPUs; i++) {
            cluster.fork();
            console.log("forked");
        }
        cluster.on('exit', function (worker, code, signal) {
            console.log('worker ' + worker.process.pid + ' died');
            cluster.fork();
        });
    } else {
        new Worker(8214);
    }

};

exports.client = require("./client");
