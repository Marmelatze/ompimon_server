var _ = require("underscore")._,
    BufferBuilder = require('buffer-builder')
;


var actions = {
    0x00: 'auth',
    0x01: 'init',
    0x02: 'send',
    0xFF: 'finalize'
};

var actionMap = {};
_.each(actions, function(actionClass, id) {
    var action = require('./actions/' + actionClass).Action;
    actionMap[id] = new action();
});

/**
 * Parse a message received by the cluster
 * @param client
 * @param buf Buffer with received message
 * @param callback will be called on error or success, first param buffer function(buf) {...}
 */
exports.parseFromCluster = function(client, buf, callback) {
    var result;
    var action = buf.readUInt8(0);
    var actionClass = actionMap[action];
    if (!actionClass) {
        result = new BufferBuilder();
        result.appendUInt8(action);
        result.appendUInt8(0x02); // invalid input
        callback(result.get());

        return;
    }

    if (!client.authenticated && actionClass.needAuthentication) {
        result = new BufferBuilder();
        result.appendUInt8(action);
        result.appendUInt8(0x03); // not authenticated
        callback(result.get());

        return;
    }

    var result = actionClass.parseFromCluster(buf.slice(1, buf.length));
    actionClass.processFromCluster(client, result, callback);
};

/**
 * Processes a message received by android client
 * @param socket
 * @param data
 * @param callback
 */
exports.processFromClient = function(socket, data, callback) {

};